# Message Formatting Feature

## ğŸ“‹ Overview

Sistem akan otomatis **menghapus prefix** dari key message sebelum disimpan ke MongoDB untuk membuat data lebih clean dan konsisten.

## âš™ï¸ Configuration

### .env File

```env
# Comma-separated list of prefixes to remove from message keys
MESSAGE_KEY_PREFIXES=INV_1_,INV_2_,INV_3_,INV_4_,CHINT_1_,CHINT_2_,CHINT_3_,CHINT_4_
```

**Cara menambah/edit prefix:**
1. Edit file `.env`
2. Tambah atau hapus prefix (pisahkan dengan koma)
3. Restart aplikasi

**Example:**
```env
# Add more prefixes
MESSAGE_KEY_PREFIXES=INV_1_,INV_2_,INV_3_,INV_4_,CHINT_1_,CHINT_2_,CHINT_3_,CHINT_4_,NEW_DEVICE_,METER_A_

# Remove some prefixes
MESSAGE_KEY_PREFIXES=INV_1_,INV_2_,CHINT_1_
```

## ğŸ”„ How It Works

### Before (Original MQTT Message)

```json
{
  "INV_1_voltage": 220.5,
  "INV_1_current": 10.2,
  "INV_1_power": 2250,
  "INV_1_energy": 1250.5
}
```

### After (Stored in MongoDB)

```json
{
  "_id": "auto-generated",
  "topic": "data/site001/realtime/energy_db/realtime_data/gateway001",
  "message": {
    "voltage": 220.5,
    "current": 10.2,
    "power": 2250,
    "energy": 1250.5
  },
  "lastUpdate": "2024-01-15T10:30:15.000Z",
  "processedAt": "2024-01-15T10:30:15.000Z",
  "receivedAt": "2024-01-15T10:30:14.000Z",
  "siteId": "site001",
  "deviceId": "INV_1",
  "gatewayId": "gateway001"
}
```

## ğŸ“Š MongoDB Document Structure

### Realtime Collection

```javascript
{
  _id: ObjectId("..."),              // Auto-generated by MongoDB
  topic: String,                     // Full MQTT topic
  message: Object,                   // Cleaned payload (prefix removed)
  lastUpdate: Date,                  // Last update timestamp
  processedAt: Date,                 // When worker processed
  receivedAt: Date,                  // When subscriber received
  siteId: String,                    // From topic
  deviceId: String,                  // Extracted from prefix (INV_1, CHINT_2, etc)
  gatewayId: String                  // From topic
}
```

### History Collection

```javascript
{
  _id: ObjectId("..."),              // Auto-generated by MongoDB
  topic: String,                     // Full MQTT topic
  message: Object,                   // Cleaned payload (prefix removed)
  processedAt: Date,                 // When worker processed
  receivedAt: Date,                  // When subscriber received
  siteId: String,                    // From topic
  deviceId: String,                  // Extracted from prefix
  gatewayId: String                  // From topic
}
```

## ğŸ” Device ID Extraction

System akan otomatis extract `deviceId` dari prefix:

| Original Key | Extracted Device ID |
|-------------|---------------------|
| `INV_1_voltage` | `INV_1` |
| `INV_2_power` | `INV_2` |
| `CHINT_1_current` | `CHINT_1` |
| `CHINT_4_energy` | `CHINT_4` |

## ğŸ§ª Testing

### Test Formatter Function

```powershell
npm run test:formatter
```

Output:
```
============================================================
Message Formatter Test
============================================================

ğŸ“¥ Original Payload (INV_1_):
{
  "INV_1_voltage": 220.5,
  "INV_1_current": 10.2,
  "INV_1_power": 2250,
  "INV_1_energy": 1250.5
}

ğŸ“¤ Cleaned Payload:
{
  "voltage": 220.5,
  "current": 10.2,
  "power": 2250,
  "energy": 1250.5
}

ğŸ” Extracted Device ID: INV_1
```

### Test with MQTT Publisher

```powershell
# Send test data with prefixes
npm run test:publisher
```

Publisher akan random kirim data dengan berbagai prefix (INV_1_, INV_2_, CHINT_1_, dll)

## ğŸ”§ Implementation Details

### File Changes

1. **`src/utils/message-formatter.js`** (NEW)
   - `removeKeyPrefixes()` - Remove prefix dari object keys
   - `extractDeviceId()` - Extract device ID dari prefix

2. **`src/config/config.js`**
   - Added `messageFormatting.keyPrefixes` configuration

3. **`src/workers/history-worker.js`**
   - Import message formatter
   - Clean payload before insert
   - Extract deviceId
   - New document structure

4. **`src/workers/realtime-worker.js`**
   - Import message formatter
   - Clean payload before upsert
   - Extract deviceId
   - New document structure

5. **`.env`**
   - Added `MESSAGE_KEY_PREFIXES` configuration

## ğŸ“ Examples

### Example 1: INV Device

**MQTT Message:**
```json
{
  "INV_1_voltage": 220,
  "INV_1_current": 10,
  "INV_1_power": 2200
}
```

**MongoDB Document:**
```json
{
  "topic": "data/site001/realtime/energy_db/realtime_data/gw001",
  "message": {
    "voltage": 220,
    "current": 10,
    "power": 2200
  },
  "deviceId": "INV_1",
  "siteId": "site001",
  "gatewayId": "gw001"
}
```

### Example 2: CHINT Device

**MQTT Message:**
```json
{
  "CHINT_2_voltage_L1": 220,
  "CHINT_2_voltage_L2": 221,
  "CHINT_2_voltage_L3": 219,
  "CHINT_2_power_total": 6600
}
```

**MongoDB Document:**
```json
{
  "topic": "data/site001/realtime/energy_db/realtime_data/gw001",
  "message": {
    "voltage_L1": 220,
    "voltage_L2": 221,
    "voltage_L3": 219,
    "power_total": 6600
  },
  "deviceId": "CHINT_2",
  "siteId": "site001",
  "gatewayId": "gw001"
}
```

## ğŸ¯ Benefits

âœ… **Clean Data**: No redundant prefixes in MongoDB
âœ… **Consistent Structure**: Same format for all devices
âœ… **Easy Querying**: Query by `deviceId` instead of prefix keys
âœ… **Flexible**: Easy to add/remove prefixes via .env
âœ… **Automatic**: No code changes needed for new devices

## ğŸ” Querying MongoDB

### Find by Device ID

```javascript
// Find all data from INV_1
db.realtime_data.find({ deviceId: "INV_1" })

// Find all data from CHINT devices
db.realtime_data.find({ deviceId: /^CHINT/ })

// Find specific device in specific site
db.realtime_data.find({ 
  siteId: "site001", 
  deviceId: "INV_1" 
})
```

### Aggregate by Device

```javascript
// Count messages per device
db.history_data.aggregate([
  {
    $group: {
      _id: "$deviceId",
      count: { $sum: 1 }
    }
  }
])

// Average power per device
db.realtime_data.aggregate([
  {
    $group: {
      _id: "$deviceId",
      avgPower: { $avg: "$message.power" }
    }
  }
])
```

## ğŸš€ Migration Notes

### Existing Data

Data lama (sebelum feature ini) akan tetap ada dengan format lama. Hanya data baru yang akan menggunakan format baru.

### Optional: Migrate Old Data

Jika ingin migrate data lama, bisa gunakan script berikut:

```javascript
// Connect to MongoDB
db.realtime_data.find().forEach(doc => {
  // Check if old format (has prefixed keys at root level)
  if (doc.INV_1_voltage || doc.CHINT_1_voltage) {
    // Extract and clean
    // ... migration logic here
  }
});
```

## âš ï¸ Important Notes

1. **Restart Required**: Setelah edit `MESSAGE_KEY_PREFIXES` di .env, restart aplikasi
2. **Prefix Order**: First match wins - jika key match multiple prefixes, yang pertama akan digunakan
3. **Nested Objects**: Formatter juga handle nested objects
4. **Case Sensitive**: Prefix matching is case-sensitive

## ğŸ“ Support

Jika ada pertanyaan tentang message formatting, refer to:
- `src/utils/message-formatter.js` - Implementation
- `test/test-formatter.js` - Test examples
- This documentation
