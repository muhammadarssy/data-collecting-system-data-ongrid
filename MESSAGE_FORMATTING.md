# Message Formatting Feature

## üìã Overview

Sistem akan otomatis:
1. **Menghapus prefix** dari key message sebelum disimpan ke MongoDB untuk membuat data lebih clean dan konsisten
2. **Pluralisasi collection name** secara otomatis sesuai aturan

## ‚öôÔ∏è Configuration

### .env File

```env
# Comma-separated list of prefixes to remove from message keys
MESSAGE_KEY_PREFIXES=INV_1_,INV_2_,INV_3_,INV_4_,CHINT_1_,CHINT_2_,CHINT_3_,CHINT_4_
```

**Cara menambah/edit prefix:**
1. Edit file `.env`
2. Tambah atau hapus prefix (pisahkan dengan koma)
3. Restart aplikasi

**Example:**
```env
# Add more prefixes
MESSAGE_KEY_PREFIXES=INV_1_,INV_2_,INV_3_,INV_4_,CHINT_1_,CHINT_2_,CHINT_3_,CHINT_4_,NEW_DEVICE_,METER_A_

# Remove some prefixes
MESSAGE_KEY_PREFIXES=INV_1_,INV_2_,CHINT_1_
```

## üîÑ How It Works

### Before (Original MQTT Message)

```json
{
  "INV_1_voltage": 220.5,
  "INV_1_current": 10.2,
  "INV_1_power": 2250,
  "INV_1_energy": 1250.5
}
```

### After (Stored in MongoDB)

```json
{
  "_id": "auto-generated",
  "topic": "data/site001/realtime/energy_db/realtime_data/gateway001",
  "message": {
    "voltage": 220.5,
    "current": 10.2,
    "power": 2250,
    "energy": 1250.5
  },
  "lastUpdate": "2024-01-15T10:30:15.000Z",
  "processedAt": "2024-01-15T10:30:15.000Z",
  "receivedAt": "2024-01-15T10:30:14.000Z",
  "siteId": "site001",
  "deviceId": "INV_1",
  "gatewayId": "gateway001"
}
```

## üìä MongoDB Document Structure

### Realtime Collection

```javascript
{
  _id: ObjectId("..."),              // Auto-generated by MongoDB
  topic: String,                     // Full MQTT topic
  message: Object,                   // Cleaned payload (prefix removed)
  lastUpdate: Date,                  // Last update timestamp
  processedAt: Date,                 // When worker processed
  receivedAt: Date,                  // When subscriber received
  siteId: String,                    // From topic
  deviceId: String,                  // Extracted from prefix (INV_1, CHINT_2, etc)
  gatewayId: String                  // From topic
}
```

### History Collection

```javascript
{
  _id: ObjectId("..."),              // Auto-generated by MongoDB
  topic: String,                     // Full MQTT topic
  message: Object,                   // Cleaned payload (prefix removed)
  processedAt: Date,                 // When worker processed
  receivedAt: Date,                  // When subscriber received
  siteId: String,                    // From topic
  deviceId: String,                  // Extracted from prefix
  gatewayId: String                  // From topic
}
```

## üîç Device ID Extraction

System akan otomatis extract `deviceId` dari prefix:

| Original Key | Extracted Device ID |
|-------------|---------------------|
| `INV_1_voltage` | `INV_1` |
| `INV_2_power` | `INV_2` |
| `CHINT_1_current` | `CHINT_1` |
| `CHINT_4_energy` | `CHINT_4` |

## üß™ Testing

### Test Collection Name Pluralization

```powershell
npm run test:pluralize
```

Output:
```
=================================
Collection Name Pluralization Test
=================================

Testing pluralization rules:
- If ends with digit ‚Üí keep as is
- If does not end with digit ‚Üí add 's'

‚úì harvest         ‚Üí harvests        (Expected: harvests)
‚úì ehub            ‚Üí ehubs           (Expected: ehubs)
‚úì ehub1           ‚Üí ehub1           (Expected: ehub1)
‚úì ehub2           ‚Üí ehub2           (Expected: ehub2)
‚úì device          ‚Üí devices         (Expected: devices)
‚úì sensor          ‚Üí sensors         (Expected: sensors)
‚úì gateway1        ‚Üí gateway1        (Expected: gateway1)
‚úì meter           ‚Üí meters          (Expected: meters)
‚úì inverter3       ‚Üí inverter3       (Expected: inverter3)
‚úì datalog         ‚Üí datalogs        (Expected: datalogs)

=================================
Results: 10 passed, 0 failed
=================================
‚úì All tests passed!
```

### Test Formatter Function

```powershell
npm run test:formatter
```

Output:
```
============================================================
Message Formatter Test
============================================================

üì• Original Payload (INV_1_):
{
  "INV_1_voltage": 220.5,
  "INV_1_current": 10.2,
  "INV_1_power": 2250,
  "INV_1_energy": 1250.5
}

üì§ Cleaned Payload:
{
  "voltage": 220.5,
  "current": 10.2,
  "power": 2250,
  "energy": 1250.5
}

üîç Extracted Device ID: INV_1
```

### Test with MQTT Publisher

```powershell
# Send test data with prefixes
npm run test:publisher
```

Publisher akan random kirim data dengan berbagai prefix (INV_1_, INV_2_, CHINT_1_, dll)

## üîß Implementation Details

### Collection Name Pluralization

**Rules:**
- Collection name yang **diakhiri angka** ‚Üí tetap apa adanya
  - `ehub1` ‚Üí `ehub1`
  - `gateway2` ‚Üí `gateway2`
  - `sensor3` ‚Üí `sensor3`

- Collection name yang **tidak diakhiri angka** ‚Üí tambah 's'
  - `harvest` ‚Üí `harvests`
  - `ehub` ‚Üí `ehubs`
  - `device` ‚Üí `devices`
  - `sensor` ‚Üí `sensors`

**Example MQTT Topic Transformation:**
```
Original Topic:
data/site001/realtime/energy_db/harvest/gw001

Processed Collection Name:
harvests (harvest + 's')

Original Topic:
data/site001/realtime/energy_db/ehub1/gw001

Processed Collection Name:
ehub1 (unchanged, ends with digit)
```

**Implementation:**
- Function: `pluralizeCollectionName()` in `src/utils/message-formatter.js`
- Used in: `src/mqtt-subscriber.js` (when parsing topic)
- Automatic: Collection name will be pluralized before storing to MongoDB

### File Changes

1. **`src/utils/message-formatter.js`** (UPDATED)
   - `removeKeyPrefixes()` - Remove prefix dari object keys
   - `extractDeviceId()` - Extract device ID dari prefix
   - `pluralizeCollectionName()` - **NEW** - Pluralize collection name

2. **`src/mqtt-subscriber.js`** (UPDATED)
   - Import `pluralizeCollectionName()`
   - Apply pluralization when parsing topic
   - Pass pluralized collection name to queue

2. **`src/config/config.js`**
   - Added `messageFormatting.keyPrefixes` configuration

3. **`src/workers/history-worker.js`**
   - Import message formatter
   - Clean payload before insert
   - Extract deviceId
   - New document structure

4. **`src/workers/realtime-worker.js`**
   - Import message formatter
   - Clean payload before upsert
   - Extract deviceId
   - New document structure

5. **`.env`**
   - Added `MESSAGE_KEY_PREFIXES` configuration

6. **`test/test-pluralize.js`** (NEW)
   - Test script untuk collection name pluralization

## üìù Examples

### Example 1: Collection Pluralization with INV Device

**MQTT Topic:**
```
data/site001/realtime/energy_db/harvest/gw001
```

**Processing:**
- Original collection: `harvest`
- Pluralized collection: `harvests` (tidak diakhiri angka ‚Üí tambah 's')

**MQTT Message:**
```json
{
  "INV_1_voltage": 220,
  "INV_1_current": 10,
  "INV_1_power": 2200
}
```

**MongoDB Document (stored in `harvests` collection):**
```json
{
  "topic": "data/site001/realtime/energy_db/harvest/gw001",
  "message": {
    "voltage": 220,
    "current": 10,
    "power": 2200
  },
  "deviceId": "INV_1",
  "siteId": "site001",
  "gatewayId": "gw001"
}
```

### Example 2: Collection with Digit (No Pluralization)

**MQTT Message:**
```json
{
  "INV_1_voltage": 220,
  "INV_1_current": 10,
  "INV_1_power": 2200
}
```

**MongoDB Document:**
```json
{
  "topic": "data/site001/realtime/energy_db/realtime_data/gw001",
  "message": {
    "voltage": 220,
    "current": 10,
    "power": 2200
  },
  "deviceId": "INV_1",
  "siteId": "site001",
  "gatewayId": "gw001"
}
```

### Example 2: Collection with Digit (No Pluralization)

**MQTT Topic:**
```
data/site001/realtime/energy_db/ehub1/gw002
```

**Processing:**
- Original collection: `ehub1`
- Pluralized collection: `ehub1` (diakhiri angka ‚Üí tetap)

**MQTT Message:**
```json
{
  "CHINT_2_voltage_L1": 220,
  "CHINT_2_voltage_L2": 221,
  "CHINT_2_voltage_L3": 219,
  "CHINT_2_power_total": 6600
}
```

**MongoDB Document (stored in `ehub1` collection):**
```json
{
  "topic": "data/site001/realtime/energy_db/ehub1/gw002",
  "message": {
    "voltage_L1": 220,
    "voltage_L2": 221,
    "voltage_L3": 219,
    "power_total": 6600
  },
  "deviceId": "CHINT_2",
  "siteId": "site001",
  "gatewayId": "gw002"
}
```

### Example 3: Multiple Collection Names

| MQTT Topic Collection | Stored in MongoDB Collection |
|----------------------|------------------------------|
| `harvest` | `harvests` |
| `ehub` | `ehubs` |
| `ehub1` | `ehub1` |
| `ehub2` | `ehub2` |
| `device` | `devices` |
| `sensor` | `sensors` |
| `gateway1` | `gateway1` |
| `meter` | `meters` |
| `inverter3` | `inverter3` |
| `datalog` | `datalogs` |

## üéØ Benefits

‚úÖ **Clean Data**: No redundant prefixes in MongoDB
‚úÖ **Consistent Structure**: Same format for all devices
‚úÖ **Easy Querying**: Query by `deviceId` instead of prefix keys
‚úÖ **Flexible**: Easy to add/remove prefixes via .env
‚úÖ **Automatic**: No code changes needed for new devices
‚úÖ **Smart Collection Names**: Automatic pluralization based on naming convention
‚úÖ **Predictable**: Clear rules for collection naming (digit vs non-digit)

## üîç Querying MongoDB

### Find by Device ID

```javascript
// Find all data from INV_1
db.realtime_data.find({ deviceId: "INV_1" })

// Find all data from CHINT devices
db.realtime_data.find({ deviceId: /^CHINT/ })

// Find specific device in specific site
db.realtime_data.find({ 
  siteId: "site001", 
  deviceId: "INV_1" 
})
```

### Aggregate by Device

```javascript
// Count messages per device
db.history_data.aggregate([
  {
    $group: {
      _id: "$deviceId",
      count: { $sum: 1 }
    }
  }
])

// Average power per device
db.realtime_data.aggregate([
  {
    $group: {
      _id: "$deviceId",
      avgPower: { $avg: "$message.power" }
    }
  }
])
```

## üöÄ Migration Notes

### Existing Data

Data lama (sebelum feature ini) akan tetap ada dengan format lama. Hanya data baru yang akan menggunakan format baru.

### Optional: Migrate Old Data

Jika ingin migrate data lama, bisa gunakan script berikut:

```javascript
// Connect to MongoDB
db.realtime_data.find().forEach(doc => {
  // Check if old format (has prefixed keys at root level)
  if (doc.INV_1_voltage || doc.CHINT_1_voltage) {
    // Extract and clean
    // ... migration logic here
  }
});
```

## ‚ö†Ô∏è Important Notes

1. **Restart Required**: Setelah edit `MESSAGE_KEY_PREFIXES` di .env, restart aplikasi
2. **Prefix Order**: First match wins - jika key match multiple prefixes, yang pertama akan digunakan
3. **Nested Objects**: Formatter juga handle nested objects
4. **Case Sensitive**: Prefix matching is case-sensitive
5. **Collection Pluralization**: Otomatis diterapkan pada semua topic yang diterima
6. **Topic vs Collection**: Collection name di topic tetap singular/original, yang di-pluralize hanya saat store ke MongoDB

## üìû Support

Jika ada pertanyaan tentang message formatting, refer to:
- `src/utils/message-formatter.js` - Implementation
- `test/test-formatter.js` - Test examples for prefix removal
- `test/test-pluralize.js` - Test examples for collection pluralization
- This documentation
